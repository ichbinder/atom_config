'use babel';

var GitCommitView = require('./git-commit-view');

var _require = require('atom');

var CompositeDisposable = _require.CompositeDisposable;

var _require2 = require('react-for-atom');

var React = _require2.React;
var ReactDOM = _require2.ReactDOM;

var CommitManagerView = require('./components/CommitManagerView.jsx');

var _require3 = require('child_process');

var exec = _require3.exec;

module.exports = GitCommit = {
  gitCommitView: null,
  modalPanel: null,
  subscriptions: null,

  activate: function activate(state) {
    var _this = this;

    this.gitCommitView = new GitCommitView(state.gitCommitViewState);
    this.gitCommitViewElement = this.gitCommitView.getElement();
    this.gitCommitViewElement.onkeydown = function (e) {
      var ctrlDown = e.ctrlKey || e.metaKey;
      if (e.which == 27) {
        // esc
        _this.toggle();
      } else if (e.which == 13) {
        //enter
        _this.toggle();
        _this.save();
      }
    };
    this.modalPanel = atom.workspace.addModalPanel({ item: this.gitCommitViewElement, visible: false });
    this.rootComponent = ReactDOM.render(React.createElement(CommitManagerView, null), this.gitCommitViewElement);
    //Events subscribed to in atom's system can be easily cleaned up with a CompositeDisposable
    this.subscriptions = new CompositeDisposable();

    //Register command that toggles this view
    this.subscriptions.add(atom.commands.add('atom-workspace', { 'git-commit:commit': function gitCommitCommit() {
        _this.toggle();
      } }));
  },

  deactivate: function deactivate() {
    this.modalPanel.destroy();
    this.subscriptions.dispose();
    this.gitCommitView.destroy();
  },

  consumeToolBar: function consumeToolBar(toolBar) {
    this.toolBar = toolBar('git-commit');

    // Adding spacer
    this.toolBar.addSpacer();

    // Using custom icon set (Ionicons)
    var commitButton = this.toolBar.addButton({
      icon: 'stagecommit',
      callback: 'git-commit:commit',
      tooltip: 'Commit',
      iconset: 'icon-git'
    });

    // Adding spacer
    this.toolBar.addSpacer();

    this.toolBar.onDidDestroy = function () {
      this.toolBar = null;
    };
  },

  serialize: function serialize() {
    return { gitCommitViewState: this.gitCommitView.serialize() };
  },
  getRepoPath: function getRepoPath() {
    var parentFolders = [];
    var parentFolder = atom.workspace.getActivePaneItem().buffer.file.getParent();
    while (parentFolder.getBaseName() != "") {
      parentFolders.push(parentFolder);
      parentFolder = parentFolder.getParent();
    }
    var existsPromises = parentFolders.map(function (path) {
      return new Promise(function (resolve, reject) {
        path.getSubdirectory(".git").exists().then(function (subdirectoryExists) {
          resolve(subdirectoryExists);
        });
      });
    });
    return Promise.all(existsPromises).then(function (results) {
      return parentFolders[results.findIndex(function (exists) {
        return exists;
      })].getPath();
    });
    // return atom.project.getPaths()[0];
  },
  execCommandInLocalProject: function execCommandInLocalProject(command, cwd) {
    return new Promise(function (resolve, reject) {
      exec(command, { cwd: cwd }, function (err, stdout, stderr) {
        if (err) reject(stderr);else resolve(stdout);
      });
    });
  },
  execCommandInRemoteProject: function execCommandInRemoteProject(command, path) {
    var node_ssh = require('node-ssh');
    var ssh = new node_ssh();
    var host = path.split("/")[2].split(":")[0];
    var workingPath = "/".concat(path.split("/").slice(3).join("/"));
    var nuclideConfig = atom.packages.config.get("nuclide");
    if (!nuclideConfig) {
      return;
    }
    var profile = nuclideConfig.connectionProfiles.find(function (profile) {
      return profile.params.server == host;
    });
    if (!profile) {
      return;
    }
    var privateKey;
    if (profile.params.authMethod == "PRIVATE_KEY") {
      privateKey = profile.params.pathToPrivateKey;
    } else {
      return;
    }
    var port = profile.params.sshPort;
    var username = profile.params.username;

    return new Promise(function (resolve, reject) {
      console.log(host, username, privateKey);
      ssh.connect({
        host: host,
        username: username,
        privateKey: privateKey
      }).then(function () {
        ssh.execCommand(command, { cwd: workingPath, stream: 'both', stdin: null }).then(function (result) {
          console.log('STDOUT: ' + result.stdout);
          console.log('STDERR: ' + result.stderr);
          ssh.end();
          if (result.code != 0) reject(result.stderr + " " + result.stdout);else resolve(result.stdout);
        });
      })['catch'](function (error) {
        ssh.end();
        reject(error);
      });
    });
  },
  execCommandInProject: function execCommandInProject(command) {
    var _this2 = this;

    return this.getRepoPath().then(function (path) {
      if (path.startsWith("nuclide")) {
        return _this2.execCommandInRemoteProject(command, path);
      } else {
        return _this2.execCommandInLocalProject(command, path);
      }
    });
  },
  getUncommitedFiles: function getUncommitedFiles() {
    var _this3 = this;

    return new Promise(function (resolve, reject) {
      _this3.execCommandInProject('git status -s').then(function (stdout) {
        resolve(stdout.split("\n").filter(function (path) {
          return path != "";
        }).filter(function (modif) {
          var modifier = modif.split(' ').filter(function (m) {
            return m != "";
          })[0];
          return modifier.indexOf("??") != -1 || modifier.indexOf("M") != -1;
        }).map(function (modif) {
          return modif.split(' ').filter(function (m) {
            return m != "";
          }).slice(1).join(' ');
        }).map(function (path) {
          var length = path.split(' ').length;
          if (length == 3) return path.split(' ')[2];else if (length > 1) return path.split(' ')[0];else return path;
        }));
      })['catch'](function (stderr) {
        reject(stderr);
      });
    });
  },
  addFiles: function addFiles() {
    var gitAddCommand = 'git add ' + this.rootComponent.getFilesToAdd().map(function (file) {
      return file;
    }).join(' ');
    return this.execCommandInProject(gitAddCommand);
  },
  commit: function commit() {
    var _this4 = this;

    return new Promise(function (resolve, reject) {
      _this4.execCommandInProject('git commit -m "' + _this4.rootComponent.refs.inputText.value + '"').then(function (stdout) {
        _this4.rootComponent.refs.inputText.value = "";
        resolve(stdout);
      })['catch'](function (stderr) {
        reject(stderr);
      });
    });
  },
  save: function save() {
    var _this5 = this;

    this.addFiles().then(function () {
      _this5.commit().then(function (stdout) {
        atom.notifications.addSuccess("Commited with success", {
          detail: stdout,
          dismissable: false
        });
      })['catch'](function (err) {
        atom.notifications.addWarning("Files have been staged");
        atom.notifications.addError("Error while commiting", {
          detail: err,
          dismissable: true
        });
      });
    })['catch'](function (err) {
      atom.notifications.addError("Error while staging files", {
        detail: err,
        dismissable: true
      });
    });
  },
  toggle: function toggle() {
    var _this6 = this;

    if (this.modalPanel.isVisible()) this.modalPanel.hide();else {
      this.getUncommitedFiles().then(function (files) {
        if (files.length > 0) {
          var filesProperties = files.map(function (file) {
            return { name: file };
          });
          _this6.rootComponent = ReactDOM.render(React.createElement(CommitManagerView, { files: filesProperties }), _this6.gitCommitViewElement);
          _this6.modalPanel.show();
          _this6.rootComponent.refs.inputText.focus();
        } else {
          atom.notifications.addWarning("No file to stage");
        }
      })['catch'](function (err) {
        atom.notifications.addError("Error while getting status", {
          detail: err,
          dismissable: true
        });
      });
    }
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2pha29iLy5hdG9tL3BhY2thZ2VzL2dpdC1jb21taXQvbGliL2dpdC1jb21taXQuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsV0FBVyxDQUFBOztBQUVYLElBQUksYUFBYSxHQUFHLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDOztlQUNyQixPQUFPLENBQUMsTUFBTSxDQUFDOztJQUF0QyxtQkFBbUIsWUFBbkIsbUJBQW1COztnQkFDQSxPQUFPLENBQUMsZ0JBQWdCLENBQUM7O0lBQTVDLEtBQUssYUFBTCxLQUFLO0lBQUUsUUFBUSxhQUFSLFFBQVE7O0FBQ3BCLElBQUksaUJBQWlCLEdBQUcsT0FBTyxDQUFDLG9DQUFvQyxDQUFDLENBQUM7O2dCQUN6RCxPQUFPLENBQUMsZUFBZSxDQUFDOztJQUFoQyxJQUFJLGFBQUosSUFBSTs7QUFFVCxNQUFNLENBQUMsT0FBTyxHQUFHLFNBQVMsR0FBRztBQUMzQixlQUFhLEVBQUUsSUFBSTtBQUNuQixZQUFVLEVBQUUsSUFBSTtBQUNoQixlQUFhLEVBQUUsSUFBSTs7QUFFbkIsVUFBUSxFQUFFLGtCQUFTLEtBQUssRUFBRTs7O0FBQ3hCLFFBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxhQUFhLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUM7QUFDakUsUUFBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxFQUFFLENBQUM7QUFDNUQsUUFBSSxDQUFDLG9CQUFvQixDQUFDLFNBQVMsR0FBRyxVQUFDLENBQUMsRUFBSztBQUMzQyxVQUFJLFFBQVEsR0FBRyxDQUFDLENBQUMsT0FBTyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUM7QUFDdEMsVUFBSSxDQUFDLENBQUMsS0FBSyxJQUFJLEVBQUUsRUFBRTs7QUFDakIsY0FBSyxNQUFNLEVBQUUsQ0FBQztPQUNmLE1BQU0sSUFBSSxDQUFDLENBQUMsS0FBSyxJQUFJLEVBQUUsRUFBRTs7QUFDeEIsY0FBSyxN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QztPQUNKLENBQUMsQ0FBQztLQUNOO0dBQ0Y7Q0FDRixDQUFDIiwiZmlsZSI6Ii9ob21lL2pha29iLy5hdG9tL3BhY2thZ2VzL2dpdC1jb21taXQvbGliL2dpdC1jb21taXQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJ1xuXG52YXIgR2l0Q29tbWl0VmlldyA9IHJlcXVpcmUoJy4vZ2l0LWNvbW1pdC12aWV3Jyk7XG52YXIge0NvbXBvc2l0ZURpc3Bvc2FibGV9ID0gcmVxdWlyZSgnYXRvbScpO1xudmFyIHtSZWFjdCwgUmVhY3RET019ID0gcmVxdWlyZSgncmVhY3QtZm9yLWF0b20nKTtcbnZhciBDb21taXRNYW5hZ2VyVmlldyA9IHJlcXVpcmUoJy4vY29tcG9uZW50cy9Db21taXRNYW5hZ2VyVmlldy5qc3gnKTtcbnZhciB7ZXhlY30gPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJyk7XG5cbm1vZHVsZS5leHBvcnRzID0gR2l0Q29tbWl0ID0ge1xuICBnaXRDb21taXRWaWV3OiBudWxsLFxuICBtb2RhbFBhbmVsOiBudWxsLFxuICBzdWJzY3JpcHRpb25zOiBudWxsLFxuXG4gIGFjdGl2YXRlOiBmdW5jdGlvbihzdGF0ZSkge1xuICAgIHRoaXMuZ2l0Q29tbWl0VmlldyA9IG5ldyBHaXRDb21taXRWaWV3KHN0YXRlLmdpdENvbW1pdFZpZXdTdGF0ZSk7XG4gICAgdGhpcy5naXRDb21taXRWaWV3RWxlbWVudCA9IHRoaXMuZ2l0Q29tbWl0Vmlldy5nZXRFbGVtZW50KCk7XG4gICAgdGhpcy5naXRDb21taXRWaWV3RWxlbWVudC5vbmtleWRvd24gPSAoZSkgPT4ge1xuICAgICAgdmFyIGN0cmxEb3duID0gZS5jdHJsS2V5IHx8IGUubWV0YUtleTtcbiAgICAgIGlmIChlLndoaWNoID09IDI3KSB7IC8vIGVzY1xuICAgICAgICB0aGlzLnRvZ2dsZSgpO1xuICAgICAgfSBlbHNlIGlmIChlLndoaWNoID09IDEzKSB7IC8vZW50ZXJcbiAgICAgICAgdGhpcy50b2dnbGUoKTtcbiAgICAgICAgdGhpcy5zYXZlKCk7XG4gICAgICB9XG4gICAgfTtcbiAgICB0aGlzLm1vZGFsUGFuZWwgPSBhdG9tLndvcmtzcGFjZS5hZGRNb2RhbFBhbmVsKHtpdGVtOiB0aGlzLmdpdENvbW1pdFZpZXdFbGVtZW50LCB2aXNpYmxlOiBmYWxzZX0pO1xuICAgIHRoaXMucm9vdENvbXBvbmVudCA9IFJlYWN0RE9NLnJlbmRlcigoPENvbW1pdE1hbmFnZXJWaWV3Lz4pLCB0aGlzLmdpdENvbW1pdFZpZXdFbGVtZW50KTtcbiAgICAvL0V2ZW50cyBzdWJzY3JpYmVkIHRvIGluIGF0b20ncyBzeXN0ZW0gY2FuIGJlIGVhc2lseSBjbGVhbmVkIHVwIHdpdGggYSBDb21wb3NpdGVEaXNwb3NhYmxlXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuXG4gICAgLy9SZWdpc3RlciBjb21tYW5kIHRoYXQgdG9nZ2xlcyB0aGlzIHZpZXdcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMuYWRkKGF0b20uY29tbWFuZHMuYWRkKCdhdG9tLXdvcmtzcGFjZScsIHsnZ2l0LWNvbW1pdDpjb21taXQnOiAoKSA9PiB7IHRoaXMudG9nZ2xlKCkgfX0pKTtcbiAgfSxcblxuICBkZWFjdGl2YXRlOiBmdW5jdGlvbigpIHtcbiAgICB0aGlzLm1vZGFsUGFuZWwuZGVzdHJveSgpXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmRpc3Bvc2UoKVxuICAgIHRoaXMuZ2l0Q29tbWl0Vmlldy5kZXN0cm95KClcbiAgfSxcblxuICBjb25zdW1lVG9vbEJhcjogZnVuY3Rpb24odG9vbEJhcikge1xuICAgIHRoaXMudG9vbEJhciA9IHRvb2xCYXIoJ2dpdC1jb21taXQnKTtcblxuICAgIC8vIEFkZGluZyBzcGFjZXJcbiAgICB0aGlzLnRvb2xCYXIuYWRkU3BhY2VyKCk7XG5cbiAgICAvLyBVc2luZyBjdXN0b20gaWNvbiBzZXQgKElvbmljb25zKVxuICAgIHZhciBjb21taXRCdXR0b24gPSB0aGlzLnRvb2xCYXIuYWRkQnV0dG9uKHtcbiAgICAgIGljb246ICdzdGFnZWNvbW1pdCcsXG4gICAgICBjYWxsYmFjazogJ2dpdC1jb21taXQ6Y29tbWl0JyxcbiAgICAgIHRvb2x0aXA6ICdDb21taXQnLFxuICAgICAgaWNvbnNldDogJ2ljb24tZ2l0JyxcbiAgICB9KTtcblxuICAgIC8vIEFkZGluZyBzcGFjZXJcbiAgICB0aGlzLnRvb2xCYXIuYWRkU3BhY2VyKCk7XG5cbiAgICB0aGlzLnRvb2xCYXIub25EaWREZXN0cm95ID0gZnVuY3Rpb24oKSB7XG4gICAgICB0aGlzLnRvb2xCYXIgPSBudWxsO1xuICAgIH07XG4gIH0sXG5cbiAgc2VyaWFsaXplOiBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4ge2dpdENvbW1pdFZpZXdTdGF0ZTogdGhpcy5naXRDb21taXRWaWV3LnNlcmlhbGl6ZSgpfTtcbiAgfSxcbiAgZ2V0UmVwb1BhdGg6IGZ1bmN0aW9uKCkge1xuICAgIGxldCBwYXJlbnRGb2xkZXJzID0gW107XG4gICAgbGV0IHBhcmVudEZvbGRlciA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVBhbmVJdGVtKCkuYnVmZmVyLmZpbGUuZ2V0UGFyZW50KCk7XG4gICAgd2hpbGUgKHBhcmVudEZvbGRlci5nZXRCYXNlTmFtZSgpICE9IFwiXCIpIHtcbiAgICAgIHBhcmVudEZvbGRlcnMucHVzaChwYXJlbnRGb2xkZXIpO1xuICAgICAgcGFyZW50Rm9sZGVyID0gcGFyZW50Rm9sZGVyLmdldFBhcmVudCgpO1xuICAgIH1cbiAgICBsZXQgZXhpc3RzUHJvbWlzZXMgPSBwYXJlbnRGb2xkZXJzLm1hcCgocGF0aCkgPT4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgcGF0aC5nZXRTdWJkaXJlY3RvcnkoXCIuZ2l0XCIpLmV4aXN0cygpLnRoZW4oKHN1YmRpcmVjdG9yeUV4aXN0cykgPT4ge1xuICAgICAgICByZXNvbHZlKHN1YmRpcmVjdG9yeUV4aXN0cyk7XG4gICAgICB9KTtcbiAgICB9KSk7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKGV4aXN0c1Byb21pc2VzKS50aGVuKChyZXN1bHRzKSA9PsKge1xuICAgICAgcmV0dXJuIHBhcmVudEZvbGRlcnNbcmVzdWx0cy5maW5kSW5kZXgoKGV4aXN0cykgPT4gZXhpc3RzKV0uZ2V0UGF0aCgpO1xuICAgIH0pO1xuICAgIC8vIHJldHVybiBhdG9tLnByb2plY3QuZ2V0UGF0aHMoKVswXTtcbiAgfSxcbiAgZXhlY0NvbW1hbmRJbkxvY2FsUHJvamVjdDogZnVuY3Rpb24oY29tbWFuZCwgY3dkKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGV4ZWMoY29tbWFuZCwge2N3ZDogY3dkfSwgKGVyciwgc3Rkb3V0LCBzdGRlcnIpID0+IHtcbiAgICAgICAgaWYgKGVycilcbiAgICAgICAgICByZWplY3Qoc3RkZXJyKTtcbiAgICAgICAgZWxzZVxuICAgICAgICAgIHJlc29sdmUoc3Rkb3V0KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9LFxuICBleGVjQ29tbWFuZEluUmVtb3RlUHJvamVjdDogZnVuY3Rpb24oY29tbWFuZCwgcGF0aCkge1xuICAgIHZhciBub2RlX3NzaCA9IHJlcXVpcmUoJ25vZGUtc3NoJyk7XG4gICAgdmFyIHNzaCA9IG5ldyBub2RlX3NzaCgpO1xuICAgIHZhciBob3N0ID0gcGF0aC5zcGxpdChcIi9cIilbMl0uc3BsaXQoXCI6XCIpWzBdO1xuICAgIHZhciB3b3JraW5nUGF0aCA9IFwiL1wiLmNvbmNhdChwYXRoLnNwbGl0KFwiL1wiKS5zbGljZSgzKS5qb2luKFwiL1wiKSk7XG4gICAgdmFyIG51Y2xpZGVDb25maWcgPSBhdG9tLnBhY2thZ2VzLmNvbmZpZy5nZXQoXCJudWNsaWRlXCIpO1xuICAgIGlmICghbnVjbGlkZUNvbmZpZykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgcHJvZmlsZSA9IG51Y2xpZGVDb25maWcuY29ubmVjdGlvblByb2ZpbGVzLmZpbmQocHJvZmlsZSA9PiBwcm9maWxlLnBhcmFtcy5zZXJ2ZXIgPT0gaG9zdCk7XG4gICAgaWYgKCFwcm9maWxlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciBwcml2YXRlS2V5O1xuICAgIGlmIChwcm9maWxlLnBhcmFtcy5hdXRoTWV0aG9kID09IFwiUFJJVkFURV9LRVlcIikge1xuICAgICAgcHJpdmF0ZUtleSA9IHByb2ZpbGUucGFyYW1zLnBhdGhUb1ByaXZhdGVLZXk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdmFyIHBvcnQgPSBwcm9maWxlLnBhcmFtcy5zc2hQb3J0O1xuICAgIHZhciB1c2VybmFtZSA9IHByb2ZpbGUucGFyYW1zLnVzZXJuYW1lO1xuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgY29uc29sZS5sb2coaG9zdCwgdXNlcm5hbWUsIHByaXZhdGVLZXkpO1xuICAgICAgc3NoLmNvbm5lY3Qoe1xuICAgICAgICBob3N0LFxuICAgICAgICB1c2VybmFtZSxcbiAgICAgICAgcHJpdmF0ZUtleVxuICAgICAgfSkudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgc3NoLmV4ZWNDb21tYW5kKGNvbW1hbmQsIHtjd2Q6IHdvcmtpbmdQYXRoLCBzdHJlYW06ICdib3RoJywgc3RkaW46IG51bGx9KS50aGVuKGZ1bmN0aW9uKHJlc3VsdCkge1xuICAgICAgICAgIGNvbnNvbGUubG9nKCdTVERPVVQ6ICcgKyByZXN1bHQuc3Rkb3V0KTtcbiAgICAgICAgICBjb25zb2xlLmxvZygnU1RERVJSOiAnICsgcmVzdWx0LnN0ZGVycik7XG4gICAgICAgICAgc3NoLmVuZCgpO1xuICAgICAgICAgIGlmIChyZXN1bHQuY29kZSAhPSAwKVxuICAgICAgICAgICAgcmVqZWN0KHJlc3VsdC5zdGRlcnIgKyBcIiBcIiArIHJlc3VsdC5zdGRvdXQpO1xuICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgIHJlc29sdmUocmVzdWx0LnN0ZG91dCk7XG4gICAgICAgIH0pO1xuICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyb3IpIHtcbiAgICAgICAgc3NoLmVuZCgpO1xuICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0sXG4gIGV4ZWNDb21tYW5kSW5Qcm9qZWN0OiBmdW5jdGlvbihjb21tYW5kKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0UmVwb1BhdGgoKS50aGVuKChwYXRoKSA9PiB7XG4gICAgICBpZiAocGF0aC5zdGFydHNXaXRoKFwibnVjbGlkZVwiKSkge1xuICAgICAgICByZXR1cm4gdGhpcy5leGVjQ29tbWFuZEluUmVtb3RlUHJvamVjdChjb21tYW5kLCBwYXRoKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZXhlY0NvbW1hbmRJbkxvY2FsUHJvamVjdChjb21tYW5kLCBwYXRoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSxcbiAgZ2V0VW5jb21taXRlZEZpbGVzOiBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5leGVjQ29tbWFuZEluUHJvamVjdChgZ2l0IHN0YXR1cyAtc2ApLnRoZW4oZnVuY3Rpb24oc3Rkb3V0KSB7XG4gICAgICAgIHJlc29sdmUoXG4gICAgICAgICAgc3Rkb3V0XG4gICAgICAgICAgICAuc3BsaXQoXCJcXG5cIilcbiAgICAgICAgICAgIC5maWx0ZXIoKHBhdGgpID0+IHtyZXR1cm4gcGF0aCAhPSBcIlwifSlcbiAgICAgICAgICAgIC5maWx0ZXIoKG1vZGlmKSA9PiB7XG4gICAgICAgICAgICAgIGxldCBtb2RpZmllciA9IG1vZGlmLnNwbGl0KCcgJykuZmlsdGVyKChtKSA9PiBtICE9IFwiXCIpWzBdO1xuICAgICAgICAgICAgICByZXR1cm4gbW9kaWZpZXIuaW5kZXhPZihcIj8/XCIpICE9IC0xIHx8IG1vZGlmaWVyLmluZGV4T2YoXCJNXCIpICE9IC0xO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5tYXAoKG1vZGlmKSA9PiBtb2RpZi5zcGxpdCgnICcpLmZpbHRlcigobSkgPT4gbSAhPSBcIlwiKS5zbGljZSgxKS5qb2luKCcgJykpXG4gICAgICAgICAgICAubWFwKChwYXRoKSA9PiB7XG4gICAgICAgICAgICAgIGxldCBsZW5ndGggPSBwYXRoLnNwbGl0KCcgJykubGVuZ3RoO1xuICAgICAgICAgICAgICBpZiAobGVuZ3RoID09IDMpXG4gICAgICAgICAgICAgICAgcmV0dXJuIHBhdGguc3BsaXQoJyAnKVsyXTtcbiAgICAgICAgICAgICAgZWxzZSBpZiAobGVuZ3RoID4gMSlcbiAgICAgICAgICAgICAgICByZXR1cm4gcGF0aC5zcGxpdCgnICcpWzBdO1xuICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgcmV0dXJuIHBhdGg7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oc3RkZXJyKSB7XG4gICAgICAgIHJlamVjdChzdGRlcnIpXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSxcbiAgYWRkRmlsZXM6IGZ1bmN0aW9uKCkge1xuICAgIHZhciBnaXRBZGRDb21tYW5kID0gYGdpdCBhZGQgJHt0aGlzLnJvb3RDb21wb25lbnQuZ2V0RmlsZXNUb0FkZCgpLm1hcChmdW5jdGlvbihmaWxlKSB7XG4gICAgICByZXR1cm4gZmlsZTtcbiAgICB9KS5qb2luKCcgJyl9YDtcbiAgICByZXR1cm4gdGhpcy5leGVjQ29tbWFuZEluUHJvamVjdChnaXRBZGRDb21tYW5kKTtcbiAgfSxcbiAgY29tbWl0OiBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5leGVjQ29tbWFuZEluUHJvamVjdChgZ2l0IGNvbW1pdCAtbSBcIiR7dGhpcy5yb290Q29tcG9uZW50LnJlZnMuaW5wdXRUZXh0LnZhbHVlfVwiYClcbiAgICAgICAgLnRoZW4oKHN0ZG91dCkgPT4ge1xuICAgICAgICAgIHRoaXMucm9vdENvbXBvbmVudC5yZWZzLmlucHV0VGV4dC52YWx1ZSA9IFwiXCI7XG4gICAgICAgICAgcmVzb2x2ZShzdGRvdXQpO1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goKHN0ZGVycikgPT4ge1xuICAgICAgICAgIHJlamVjdChzdGRlcnIpO1xuICAgICAgICB9KVxuICAgIH0pO1xuICB9LFxuICBzYXZlOiBmdW5jdGlvbigpIHtcbiAgICB0aGlzLmFkZEZpbGVzKClcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgdGhpcy5jb21taXQoKVxuICAgICAgICAgIC50aGVuKChzdGRvdXQpID0+IHtcbiAgICAgICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRTdWNjZXNzKFwiQ29tbWl0ZWQgd2l0aCBzdWNjZXNzXCIsIHtcbiAgICAgICAgICAgICAgZGV0YWlsOiBzdGRvdXQsXG4gICAgICAgICAgICAgIGRpc21pc3NhYmxlOiBmYWxzZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSlcbiAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkV2FybmluZyhcIkZpbGVzIGhhdmUgYmVlbiBzdGFnZWRcIik7XG4gICAgICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoXCJFcnJvciB3aGlsZSBjb21taXRpbmdcIiwge1xuICAgICAgICAgICAgICBkZXRhaWw6IGVycixcbiAgICAgICAgICAgICAgZGlzbWlzc2FibGU6IHRydWVcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0pO1xuICAgICAgfSlcbiAgICAgIC5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKFwiRXJyb3Igd2hpbGUgc3RhZ2luZyBmaWxlc1wiLCB7XG4gICAgICAgICAgZGV0YWlsOiBlcnIsXG4gICAgICAgICAgZGlzbWlzc2FibGU6IHRydWVcbiAgICAgICAgfSk7XG4gICAgICB9KVxuICB9LFxuICB0b2dnbGU6IGZ1bmN0aW9uKCkge1xuICAgIGlmICh0aGlzLm1vZGFsUGFuZWwuaXNWaXNpYmxlKCkpXG4gICAgICB0aGlzLm1vZGFsUGFuZWwuaGlkZSgpXG4gICAgZWxzZSB7XG4gICAgICB0aGlzLmdldFVuY29tbWl0ZWRGaWxlcygpXG4gICAgICAgIC50aGVuKChmaWxlcykgPT4ge1xuICAgICAgICAgIGlmIChmaWxlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICB2YXIgZmlsZXNQcm9wZXJ0aWVzID0gZmlsZXMubWFwKGZ1bmN0aW9uKGZpbGUpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHtuYW1lOiBmaWxlfTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdGhpcy5yb290Q29tcG9uZW50ID0gUmVhY3RET00ucmVuZGVyKCg8Q29tbWl0TWFuYWdlclZpZXcgZmlsZXM9e2ZpbGVzUHJvcGVydGllc30vPiksIHRoaXMuZ2l0Q29tbWl0Vmlld0VsZW1lbnQpO1xuICAgICAgICAgICAgdGhpcy5tb2RhbFBhbmVsLnNob3coKVxuICAgICAgICAgICAgdGhpcy5yb290Q29tcG9uZW50LnJlZnMuaW5wdXRUZXh0LmZvY3VzKCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRXYXJuaW5nKFwiTm8gZmlsZSB0byBzdGFnZVwiKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoXCJFcnJvciB3aGlsZSBnZXR0aW5nIHN0YXR1c1wiLCB7XG4gICAgICAgICAgICBkZXRhaWw6IGVycixcbiAgICAgICAgICAgIGRpc21pc3NhYmxlOiB0cnVlXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgfSxcbn07XG4iXX0=
//# sourceURL=/home/jakob/.atom/packages/git-commit/lib/git-commit.js
